#!/bin/sh

set -o nounset

scriptname=${0##*/}

warn () { msg="%s: $1"'\n'; shift; printf "$msg" "$scriptname" "$@" >&2; }
die () { warn "$@"; exit 1; }
usage () { cat; } <<USAGE
usage: $scriptname [-h/--help] [-tTRASHDIR] [--] [files ...]
   Moves files to the trash, possibly renaming them. The trash dir is
   controlled by the variable 'SampShell_TRASHDIR'
USAGE

trashdir=${SampShell_TRASHDIR:-}

until [ "$#" -eq 0 ]; do
	case "$1" in
		--) shift; break;;
		-h|--help) usage; exit 0 ;;
		-t*)
			trashdir=${1#-t}
			if [ -z "$trashdir" ]; then
				shift
				trashdir=${1-}
				[ -z "$trashdir" ] && die 'missing trash directory for -t'
			fi ;;
		*) break ;;
	esac
	shift
done

[ -z "$trashdir" ] && die "missing trashdir; pass it with '-t' or set \$SampShell_TRASHDIR"
[ "$#" -eq 0 ] && usage

if [ ! -e "$trashdir" ]; then
	mkdir -p "$trashdir" || exit
elif [ ! -d "$trashdir" ]; then
	die "trashdir exists, but isn't a dir: %s" "$trashdir"
fi

# `exec` so we don't fork
exec mv-safe --rename --no-clobber-empty -- "$@" "$trashdir"
