#!/usr/bin/env ruby
BEGIN {
	Dir.chdir '/Users/sampersand/.sampshell'
	$* << '-U'
}

require 'set'

if $*.first == '-U'
	dirs = Set.new
	$*.shift
end

remaining = Integer($*.shift || 10, exception: false) or abort "usage: #$0 [-U] [amnt=10]"
i = 1

AMOUNT_OF_BRANCHES = remaining * 10

while remaining.nonzero? && i < 10_0
	$stdin.close rescue nil

	$stdin = IO.popen(
		p(['git', 'rev-parse', '--symbolic-full-name', *(i..i+AMOUNT_OF_BRANCHES).map{|x| "@{-#{x}}" }]),
		err: :close
	)

	while gets && (i+=1; remaining.nonzero?)
		next if ~/\A@{-\d+}\Z/
		$_.delete_prefix! 'refs/head/'
		dirs.add? $_ or next if dirs

		puts "%-3d %s" % [i, $_]
		remaining -= 1
	end
end

__END__
SampShell-script

# TODO: help
if [[ $1 = -U ]]; then
	typeset -aU dirs
	unique=1
	shift
fi

amnt=$(( ${1:-10} + 0 ))
remaining=$amnt
i=1

while (( 0 < remaining && i < 10000 )); do
	git rev-parse --symbolic-full-name @\{-{$i..$((i + remaining - 1))}\} 2>/dev/null |
	while ((i++, 0 < remaining)) && read -r dir; do
		[[ $dir = @\{<->\} ]] && continue
		if (( unique )); then
			prev=$#dirs
			dirs+=($dir)
			(( prev = $#dirs )) && continue
		fi

		printf '%-3d %\n' $i ${dir#refs/head/}
		(( remaining -- ))
	done
done

(( remaining != )) && echo "not all entries could be printed; $remaining remaining" >&2
