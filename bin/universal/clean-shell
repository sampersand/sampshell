#!/bin/bash

set -euo pipefail

usage () { cat <<EOS; }
usage: $(basename -- "$0") SHELL [options] [-- [shell options]]

Starts a "clean shell" up, without any noise from the environment/startup files

The 'options' are anything found in 'clenv', with also '-s' as shorthand for
-m'^SampShell_' and '-h' as this usage.
EOS

# Fetch the shell name (making sure it's supplied)
if (( $# == 0 )); then usage >&2; exit 1; fi
shellname=$1
shift

# Setup variable lists
clenv_args=()
shell_args=()

# Default shell variables for each shell to limit startup files
case $shellname in
zsh|*/zsh)
	shell_args+=( --no-globalrcs --no-rcs )
	;;
bash|*/bash)
	# Ignore macOS's deprecation of bash
	if [[ "$(uname)" = Darwin ]]; then
		clenv_args+=( -vBASH_SILENCE_DEPRECATION_WARNING=1 )
	fi

	shell_args+=( --noprofile --norc )
	;;
esac

# Parse clenv arguments, if present
while (( $# > 0 )); do
	arg=$1
	shift

	case $arg in
	--) break ;;
	-h) usage; exit ;;
	-s) clenv_args+=( -m'^SampShell_' ) ;;
	*)  clenv_args+=( "$arg" ) ;;
	esac
done

shell_args+=( "$@" )

exec clenv "${clenv_args[@]+"${clenv_args[@]}"}" -- "$shellname" "${shell_args[@]+"${shell_args[@]}"}"
