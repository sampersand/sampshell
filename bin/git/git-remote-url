#!/usr/bin/env ruby

##
# Print the url for a repo, or a file in the repo
##

require 'optparse'

PROGRAM_NAME = File.basename($0, '.*').sub(/\Agit-/, 'git ')

def abort(msg)
  super("#{PROGRAM_NAME}: #{msg}")
end

def `(cmd)
  super.chomp.tap do
    $?.success? or abort "shell command return non-zero exit status: #{cmd.inspect}"
  end
end

$branch = :master

OptParse.new nil, 20 do |op|
  op.program_name = PROGRAM_NAME
  op.banner = "usage: #{op.program_name} [options] [file] [start[-end]]"

  op.on_head 'Print the link to a repository, a file in the repo, or a range within it.'

  op.on '-r', '--repo=REPO', 'Use REPO; if not specified, uses REPO containing FILE. If no FILE, uses PWD.' do |repo|
    $repo = repo
  end

  op.on '-b', '--branch=NAME', 'Explicitly use branch NAME' do |branch|
    $branch = branch
  end

  op.on '-c', '--current', 'Use the current branch' do
    $branch = :current
  end

  op.on '-m', '--master', 'Use the master branch [default]' do
    $branch = :master
  end

  op.on '-p', '--permalink', 'Use a permalink' do
    $branch = :permalink
  end

  begin
    op.parse!
  rescue OptionParser::InvalidOption => err
    abort err
  end

  unless $*.length <= 2
    abort op.help
  end
end

file, range = $*

if $repo
  Dir.chdir $repo rescue abort "cannot cd to repo #$repo"
elsif file
  dir = File.directory?(file) ? file : File.dirname(file)
  Dir.chdir(dir) rescue abort "cannot cd to dir: #{dir}"
end

REPO = `gh repo view --json=url --jq=.url`
BRANCH = case $branch
         when :current   then `git branch --show-current`
         when :master    then `git master-branch`
         when :permalink then `git rev-parse HEAD`
         else                 $branch
         end

if file
  if File.directory?(file) && !file.end_with?('/')
    file += '/'
  end

  file = file.delete_prefix(`git rev-parse --show-toplevel` + '/') # maybe also --show-prefix eventually?
  file.concat "#L#{range.sub('-', '-L')}" if range
end

if !file && $branch == :master
  puts REPO
else
  puts "#{REPO}/#{file ? 'blob' : 'tree'}/#{BRANCH}#{file && '/'}#{file}"
end
